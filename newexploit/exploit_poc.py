
import http.server
import socketserver
import socket
import os

# --- Configuration ---
PORT = 8003
FILES_TO_SERVE = [
    "BLDatabaseManager.sqlite",
    "downloads.28.sqlitedb",
    "iPhone13,2_26.0.1_MobileGestalt.epub",
    "iTunesMetadata.plist"
]

# --- Helper to get local IP ---
def get_local_ip():
    """Finds the local IP address of the machine."""
    s = socket.socket(socket.AF_INET, socket.SOCK_DGRAM)
    try:
        # Doesn't even have to be reachable
        s.connect(('10.255.255.255', 1))
        IP = s.getsockname()[0]
    except Exception:
        IP = '127.0.0.1'
    finally:
        s.close()
    return IP

# --- Main Execution ---
if __name__ == "__main__":
    # Verify necessary files are present
    for f in FILES_TO_SERVE:
        if not os.path.exists(f):
            print(f"[ERROR] Critical file not found: {f}")
            print("Please ensure all PoC files are in the same directory as this script.")
            exit(1)

    # Start the server
    Handler = http.server.SimpleHTTPRequestHandler
    with socketserver.TCPServer(("", PORT), Handler) as httpd:
        local_ip = get_local_ip()

        # --- Instructions and Disclaimer ---
        print("="*80)
        print("  iOS Sandbox Escape PoC - HTTP Server for Security Research")
        print("="*80)
        print("\n*** FOR EDUCATIONAL AND AUTHORIZED RESEARCH PURPOSES ONLY ***")
        print("This script hosts the files required to test the sandbox escape PoC.")
        print("It does NOT perform any exploit. You must manually place the files on the target device.")
        print("\n--- SERVER IS RUNNING ---")
        print(f"Host: {local_ip}")
        print(f"Port: {PORT}")
        print(f"\nAccess files at: http://{local_ip}:{PORT}/<filename>")
        print("\n--- RESEARCH INSTRUCTIONS ---")
        print("1. Connect your target iOS device to the same local network as this computer.")
        print("2. On the device, download the required files from the server.")
        print("   Example (using curl on a jailbroken device):")
        for f in FILES_TO_SERVE:
            print(f"   # curl -O http://{local_ip}:{PORT}/{f}")
        print("\n3. Move the downloaded files to the appropriate locations to trigger the PoC.")
        print("   This is the core of the research task. Based on the README, you would:")
        print("\n   - STAGE 1 (itunesstored):")
        print("     Place 'BLDatabaseManager.sqlite' into a writable container directory, such as:")
        print("     -> /private/var/containers/Shared/SystemGroup/.../Library/Caches/")
        print("\n   - STAGE 2 (bookassetd):")
        print("     Place 'downloads.28.sqlitedb' in the appropriate database location for bookassetd,")
        print("     which will then use the 'iPhone13,2_26.0.1_MobileGestalt.epub' payload.")
        print("\n4. Monitor the device for the effects of the PoC, such as the creation of")
        print("   a modified 'com.apple.MobileGestalt.plist' file.")
        print("\n---")
        print("\nPress Ctrl+C to stop the server.")

        try:
            httpd.serve_forever()
        except KeyboardInterrupt:
            print("\n\n[INFO] Server shutting down.")
            httpd.shutdown()
